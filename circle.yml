machine:
  environment:
    PATH: "~/$CIRCLE_PROJECT_REPONAME/gradle-2.9/bin:$PATH"
    TERM: "dumb"
    ADB_INSTALL_TIMEOUT: "10"
    GRADLE_OPTS: '-Dorg.gradle.jvmargs="-Xmx2048m -XX:+HeapDumpOnOutOfMemoryError"'
    COVERALLS_REPO_TOKEN: "INZ2mjiOggmTmnBrdcYHASOfEOIYkPgLa"
    COVERALLS_PARALLEL: 'True'

dependencies:
  pre:
    - wget "https://services.gradle.org/distributions/gradle-2.9-bin.zip"; unzip gradle-2.9-bin.zip
    - echo y | android update sdk --no-ui --all --filter tool,extra-android-m2repository,extra-android-support,extra-google-google_play_services,extra-google-m2repository,android-23
    - echo y | android update sdk --no-ui --all --filter build-tools-23.0.2

test:
  pre:
  # emulator startup need some minutes that's why start it before first build/test steps for build speed up
    - emulator -avd circleci-android22 -no-audio -no-window:
        background: true
        parallel: true

  override:
    # Build the code
    - ./gradlew app:assembleDebug

    # Execute Unit Tests
    - ./gradlew app:test

    # Check lint hints
    - ./gradlew app:lint

    # ensure that the emulator is ready to use
    - circle-android wait-for-boot
    # the necessary sleep duration may change with time and depends on the pre tasks length.
    # When all pre tasks are run long enough then waiting will not be necessary anymore.
    # This sleep should avoid the com.android.builder.testing.api.DeviceException: com.android.ddmlib.ShellCommandUnresponsiveException
    - sleep 30
    # at least remove the look screen
    - adb shell input keyevent 82

    # later we collect the logs from test run
    - adb logcat -d

    # execute tests on emulator
    - ./gradlew app:connectedCheck
    #- ./gradlew connectedAndroidTest -PdisablePreDex

    # Create coverage report
    - ./gradlew jacocoFullReport

    # copy test results
    - mv app/build/reports/tests/debug $CIRCLE_TEST_REPORTS/AppUnitTests
    - mv app/build/reports/androidTests/connected $CIRCLE_TEST_REPORTS/AndroidTests
    - mv build/reports/jacoco/test/html $CIRCLE_TEST_REPORTS/CodeCoverageReport

    # copy lint report
    - mkdir $CIRCLE_TEST_REPORTS/Lint
    - mv app/build/outputs/lint-results_files $CIRCLE_TEST_REPORTS/Lint
    - mv app/build/outputs/lint-results.html $CIRCLE_TEST_REPORTS/Lint/lint-app-results.html

    # circleCi proper test value feature
    - mkdir $CIRCLE_TEST_REPORTS/junit
    - find */build/test-results -name "*.xml" -exec cp {} $CIRCLE_TEST_REPORTS/junit/ \;
    - find */build/outputs/androidTest-results/ -name "*.xml" -exec cp {} $CIRCLE_TEST_REPORTS/junit/ \;

    # copy the build outputs to artifacts
    #- cp -r app/build/outputs $CIRCLE_ARTIFACTS
    # copy the test results to the test results directory.
    #- cp -r app/build/outputs/androidTest-results/* $CIRCLE_TEST_REPORTS

    # collect logs from emulator
    - adb logcat -d > $CIRCLE_ARTIFACTS/logcat_emulator.txt

#  post:
#    - ./gradlew jacocoFullReport coveralls

# Only executed if all tasks are successful
deployment:

  # report coverage to coveralls
  coverage:
    branch: [master, rewrite]
    commands:
    - ./gradlew coveralls